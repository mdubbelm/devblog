---
title: "106 tests later"
date: 2025-12-12
tags: [testing, bugs, refactoring, quality]
user_time: "15 min"
ai_time: "1.5 uur"
efficiency: "1:6"
mood: "✅"
---

Vandaag begon met een mysterie: de "Bewerk" knop was verdwenen. En het eindigde met 106 nieuwe tests. Soms nemen sessies onverwachte wendingen.

---

## De verdwenen knop

Het viel me pas op toen ik mijn ochtendroutine wilde aanpassen. De "Bewerk ingevulde secties" knop was weg. Gewoon... foetsie.

Claude dook in de code. De knop stond er nog wel, maar met `class="hidden"`. De logica om hem te tonen checkte of een sectie "complete" was - en "complete" betekende: alle velden ingevuld én de `explicitSave` flag gezet.

Het probleem: als je data via autosave was opgeslagen, of als oudere data die flag niet had, zag het systeem de sectie niet als "compleet". Dus geen knop.

---

## De fix

De oplossing was simpeler denken. In plaats van te checken of secties "complete" waren, checken of er *überhaupt* data was.

```javascript
export function hasAnyData(todayData) {
    const dataFields = [
        'sleepScore', 'backPain', 'dreamed', 'weight',
        'walked', 'mood', 'waterIntake', 'reading', 'energyLevel'
    ];

    return dataFields.some(field => {
        const value = todayData[field];
        return value !== undefined && value !== null && value !== '';
    });
}
```

Vijftien minuten werk. Knop terug.

---

## En toen: tests

Ik had issues open staan voor test coverage. "We hebben toch al tests?" dacht ik. Maar de cijfers vertelden een ander verhaal:

- **storage.js**: 0%
- **timeService.js**: 15%
- **dataManager.js**: 0%

Dat is niet "we hebben tests". Dat is "we doen alsof".

Claude begon. Storage functies. Time-based visibility. Data sanitization. De tests stroomden binnen.

Het lastige: sommige functies zijn tijdafhankelijk. "Is het ochtend?" hangt af van de klok. Hoe test je dat betrouwbaar?

De truc: mock de `Date` class.

```javascript
function mockHour(hour) {
    global.Date = class extends Date {
        getHours() { return hour; }
    };
}

it('shows morning section at 8am', () => {
    mockHour(8);
    expect(getSectionVisibility({}).morning.visible).toBe(true);
});
```

Nu kan ik testen wat er om 8 uur 's ochtends gebeurt, ook al is het middernacht.

---

## De cijfers

**Voor:**
- 51 tests totaal
- Core services grotendeels ongetest

**Na:**
- 157 tests totaal (+106!)
- storage.js: 0% → **84%**
- timeService.js: 15% → **100%**

Die 100% voor timeService voelt goed. Alle paden getest. Alle edge cases. Als daar iets breekt, weet ik het meteen.

---

## Wat niet lukte

De import functies (JSON en CSV importeren) bleven ongetest. Ze gebruiken `File.text()`, een browser API die niet werkt in de test-omgeving.

Dat is jammer, maar niet kritiek. Die functies worden zelden gebruikt en kunnen later via E2E tests gedekt worden.

Soms is "goed genoeg" de juiste keuze.

---

## Reflectie

Vandaag voelde productief. Niet door grote features, maar door fundament leggen. Tests zijn onzichtbaar voor gebruikers, maar ze vangen bugs voordat die gebruikers bereiken.

En die verdwenen knop? Die had ik zonder tests ook kunnen fixen. Maar nu weet ik zeker dat de fix werkt. En blijft werken.

---

*157 tests. 84% coverage op storage. Dat is geen perfectie, maar het is een stuk beter dan gisteren.*
